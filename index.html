<!DOCTYPE html>
<html>
  <head>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script>
      // コントローラーUIとインタラクションのコンポーネント
      AFRAME.registerComponent('controller-ui', {
        init: function() {
          const controllerEl = this.el;
          
          // エンティティがロードされた後にUIパネルを作成
          controllerEl.addEventListener('loaded', () => {
            // 利き手ではない方（左手）のみUIパネルを作成
            if (controllerEl.getAttribute('hand-controls').hand === 'left') {
              const uiPanel = document.createElement('a-entity');
              uiPanel.setAttribute('id', 'ui-panel-left');
              uiPanel.setAttribute('geometry', {
                primitive: 'plane',
                width: 0.5,
                height: 0.3
              });
              uiPanel.setAttribute('material', {
                color: '#fff',
                transparent: true,
                opacity: 0.8
              });
              
              // パネルのヘッダーテキスト
              const headerText = document.createElement('a-entity');
              headerText.setAttribute('text', {
                value: 'Controls',
                color: '#000',
                align: 'center',
                width: 1.2
              });
              headerText.setAttribute('position', '0 0.1 0.01');
              uiPanel.appendChild(headerText);

              // + ボタンを作成
              const plusButton = document.createElement('a-entity');
              plusButton.setAttribute('id', 'plus-button');
              plusButton.setAttribute('geometry', {
                primitive: 'plane',
                width: 0.2,
                height: 0.2
              });
              plusButton.setAttribute('material', {
                color: '#4CAF50'
              });
              plusButton.setAttribute('text', {
                value: '+',
                color: '#fff',
                align: 'center',
                width: 0.5
              });
              plusButton.setAttribute('position', '0 -0.05 0.01'); // パネル内に配置
              uiPanel.appendChild(plusButton);
              
              // コントローラーの正面にパネルを配置
              uiPanel.setAttribute('position', '0 0.1 -0.5'); 
              controllerEl.appendChild(uiPanel);

              // + ボタンのクリックイベントリスナー
              plusButton.addEventListener('click', () => {
                console.log('+ button clicked!');
                // 新しいボックスを生成
                const newBox = document.createElement('a-box');
                newBox.setAttribute('position', '0 1 -2'); // ユーザーの少し前に配置
                newBox.setAttribute('rotation', '0 45 0');
                newBox.setAttribute('color', '#FFC300');
                newBox.setAttribute('shadow', '');
                newBox.setAttribute('class', 'collidable'); // レイキャストの対象にする
                document.querySelector('a-scene').appendChild(newBox);
              });

            }
          });
        }
      });

      // 右手コントローラーのレイキャストとインタラクション処理
      AFRAME.registerComponent('right-hand-interactions', {
        init: function() {
          const controllerEl = this.el;

          // トリガーが押されたときの処理
          controllerEl.addEventListener('triggerdown', () => {
            console.log('Right hand trigger pressed!');
            const raycaster = controllerEl.components.raycaster;
            if (raycaster && raycaster.intersections.length > 0) {
              const intersectedEl = raycaster.intersections[0].object.el;
              // 交差した要素が + ボタンかチェック
              if (intersectedEl.id === 'plus-button') {
                intersectedEl.emit('click');
              } else {
                // レイキャストが当たった最初のオブジェクトをハイライト
                intersectedEl.setAttribute('material', 'color', '#FF0000');
              }
            }
          });
          
          // トリガーが離されたときの処理
          controllerEl.addEventListener('triggerup', () => {
            console.log('Trigger released!');
            const raycaster = controllerEl.components.raycaster;
            if (raycaster && raycaster.intersections.length > 0) {
              const intersectedEl = raycaster.intersections[0].object.el;
              // ハイライトを元に戻す
              if (intersectedEl.id !== 'plus-button') {
                intersectedEl.setAttribute('material', 'color', '#4CC3D9');
              }
            }
          });
        }
      });
    </script>
    <style>
      #startButton {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        padding: 20px 40px;
        font-size: 24px;
        cursor: pointer;
        z-index: 999;
        background-color: #4CAF50;
        color: white;
        border: none;
        border-radius: 10px;
      }
    </style>
  </head>
  <body>
    <button id="startButton">START</button>

    <a-scene 
      id="ar-scene"
      xr-mode-ui="true" 
      renderer="colorManagement: true;" 
      ar-mode-ui="enabled: false;"
      embedded>
      
      <a-camera 
        look-controls 
        ar-camera-mode="true" 
        position="0 1.6 0">
      </a-camera>

      <a-entity 
        id="left-hand" 
        hand-controls="hand: left" 
        controller-ui>
      </a-entity>
      
      <a-entity 
        id="right-hand" 
        hand-controls="hand: right" 
        raycaster="objects: .collidable, #plus-button;" 
        right-hand-interactions>
      </a-entity>

      <a-box 
        class="collidable" 
        position="-1 0.5 -3" 
        rotation="0 45 0" 
        color="#4CC3D9" 
        shadow>
      </a-box>
      <a-sphere 
        class="collidable" 
        position="1 0.5 -3" 
        rotation="0 45 0" 
        color="#EF2D5E" 
        shadow>
      </a-sphere>

    </a-scene>
    
    <script>
      document.getElementById('startButton').addEventListener('click', () => {
        const sceneEl = document.querySelector('a-scene');
        if (sceneEl.hasLoaded) {
          sceneEl.enterAR();
          document.getElementById('startButton').style.display = 'none';
        }
      });
    </script>
  </body>
</html>
