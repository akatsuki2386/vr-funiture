<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>VR Furniture Planner</title>
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-extras@6.1.1/dist/aframe-extras.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/aframe-event-set-component@4.2.1/dist/aframe-event-set-component.min.js"></script>
    
    <script>
      // 家具のデータ
      const furnitureData = [
          { id: 'sofa', name: 'ソファ', model: 'https://cdn.aframe.io/models/gltf/a-frame-3d-model/obj/sofa.obj' },
          { id: 'table', name: 'テーブル', model: 'https://cdn.aframe.io/models/gltf/a-frame-3d-model/obj/table.obj' },
          { id: 'chair', name: '椅子', model: 'https://cdn.aframe.io/models/gltf/a-frame-3d-model/obj/chair.obj' },
      ];

      // 共通ボタン生成関数
      function createButton(text, color, position, id) {
          const button = document.createElement('a-plane');
          button.setAttribute('width', '0.4');
          button.setAttribute('height', '0.1');
          button.setAttribute('color', color);
          button.setAttribute('position', position);
          button.setAttribute('text', `value: ${text}; align: center; color: white;`);
          button.classList.add('collidable');
          button.setAttribute('id', id);
          return button;
      }

      // UIパネルを生成する関数
      function createUIPanel() {
          const panelContainer = document.createElement('a-entity');
          panelContainer.setAttribute('position', '0 0.2 -0.5');
          panelContainer.setAttribute('rotation', '-15 0 0');

          // メインメニューパネル
          const mainMenu = document.createElement('a-plane');
          mainMenu.setAttribute('width', '0.5');
          mainMenu.setAttribute('height', '0.8');
          mainMenu.setAttribute('color', '#333');
          mainMenu.setAttribute('opacity', '0.7');
          mainMenu.setAttribute('id', 'main-menu');
          
          // 家具選択パネル
          const furnitureMenu = document.createElement('a-plane');
          furnitureMenu.setAttribute('width', '0.5');
          furnitureMenu.setAttribute('height', '0.8');
          furnitureMenu.setAttribute('color', '#555');
          furnitureMenu.setAttribute('opacity', '0.7');
          furnitureMenu.setAttribute('id', 'furniture-menu');
          furnitureMenu.setAttribute('visible', 'false');
          
          // メインメニューのボタン
          const addButton = createButton('モデルの追加', '#5cb85c', '0 0.3 0.01', 'add-button');
          const helpButton = createButton('動作の説明', '#f0ad4e', '0 0 0.01', 'help-button');
          const exitButton = createButton('シミュレーションの終了', '#d9534f', '0 -0.3 0.01', 'exit-button');
          
          mainMenu.appendChild(addButton);
          mainMenu.appendChild(helpButton);
          mainMenu.appendChild(exitButton);
          
          // 家具リストボタンの作成と追加
          furnitureData.forEach((furniture, index) => {
              const yPos = 0.3 - (index * 0.15);
              const furnitureButton = createButton(furniture.name, '#5bc0de', `0 ${yPos} 0.01`, `furniture-button-${furniture.id}`);
              furnitureButton.setAttribute('data-model-id', furniture.id);
              furnitureMenu.appendChild(furnitureButton);
          });

          const backButton = createButton('戻る', '#f0ad4e', '0 -0.3 0.01', 'back-button');
          furnitureMenu.appendChild(backButton);

          panelContainer.appendChild(mainMenu);
          panelContainer.appendChild(furnitureMenu);
          
          return panelContainer;
      }
      
      document.addEventListener('DOMContentLoaded', () => {
        const startVrBtn = document.getElementById('start-vr-btn');
        const vrScene = document.querySelector('a-scene');

        // VRモードに移行した後の処理
        vrScene.addEventListener('enter-vr', () => {
          document.getElementById('start-ui').style.display = 'none';

          const handedness = 'right'; // 利き手は一旦固定
          const rightHand = document.getElementById('right-hand');
          const leftHand = document.getElementById('left-hand');
          
          // レイキャストの追加
          rightHand.setAttribute('raycaster', 'objects: .collidable; showLine: true; far: 5;');
          leftHand.setAttribute('raycaster', 'objects: .collidable; showLine: true; far: 5;');
          
          const uiPanel = createUIPanel();
          
          if (handedness === 'right') {
              leftHand.appendChild(uiPanel);
          } else {
              rightHand.appendChild(uiPanel);
          }

          // ボタンのイベントリスナー設定
          const mainMenu = document.getElementById('main-menu');
          const furnitureMenu = document.getElementById('furniture-menu');
          
          // 「モデルの追加」ボタンのイベント
          document.getElementById('add-button').addEventListener('click', () => {
              mainMenu.setAttribute('visible', 'false');
              furnitureMenu.setAttribute('visible', 'true');
          });
          
          // 「戻る」ボタンのイベント
          document.getElementById('back-button').addEventListener('click', () => {
              furnitureMenu.setAttribute('visible', 'false');
              mainMenu.setAttribute('visible', 'true');
          });

          // 家具ボタンのクリックイベント
          furnitureData.forEach(furniture => {
              document.getElementById(`furniture-button-${furniture.id}`).addEventListener('click', () => {
                  console.log(`${furniture.name}が選択されました！`);
                  // ここに家具モデルの生成ロジックを追加
              });
          });
        });
      });
    </script>
  </head>
  <body>
    <div id="start-ui" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 1000; background: rgba(0, 0, 0, 0.7); padding: 5vw; border-radius: 10px; text-align: center; color: white; font-family: sans-serif; box-sizing: border-box; max-width: 90vw;">
      <h1>VR Furniture Planner</h1>
      <button id="start-vr-btn" style="padding: 1vw 2vw; margin: 1vw; font-size: 3vw;">START VR</button>
    </div>

    <a-scene 
      webxr="requiredFeatures: local-floor" 
      renderer="colorManagement: true;"
      vr-mode-ui="enterVRButton: #start-vr-btn;"
    >
      <a-assets>
      </a-assets>

      <a-entity id="left-hand" hand-controls="hand: left;"></a-entity>
      <a-entity id="right-hand" hand-controls="hand: right;"></a-entity>

      <a-entity id="ui-panel-holder"></a-entity>
      
      <a-entity camera look-controls wasd-controls></a-entity>
      
      <a-sky color="#ECECEC"></a-sky>
    </a-scene>
  </body>
</html>
