<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>VR家具配置シミュレーション</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            margin: 0;
            background-color: #1A202C;
            color: white;
            font-family: sans-serif;
            overflow: hidden;
        }
        canvas { display: block; }
        #title-container {
            position: absolute;
            top: 40%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 5;
            width: 90%;
        }
        #title-container h1 {
            font-size: 2.2rem;
            font-weight: bold;
            line-height: 1.4;
            color: white;
            text-shadow: 0 2px 8px rgba(0,0,0,0.5);
        }
        #overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
            pointer-events: none;
        }

        /* VR版ではDOMベースのUIは使用しないため、非表示に */
        #instruction-text, #bottom-bar, #top-left-controls, #top-right-controls,
        #help-modal, #confirm-dialog, #furniture-modal, #mode-switch-button {
            display: none;
        }
    </style>
</head>
<body>
    <div id="title-container">
        <h1>VR家具配置<br>シミュレーション</h1>
    </div>

    <div id="overlay">
        </div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
                "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { VRButton } from 'three/addons/webxr/VRButton.js';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { XRControllerModelFactory } from 'three/addons/webxr/XRControllerModelFactory.js';

        function main() {
            setupWebXR();
        }

        function setupWebXR() {
            let camera, scene, renderer;
            const loader = new GLTFLoader();
            const preloadedModels = new Map();
            const placedObjects = [];
            const raycaster = new THREE.Raycaster();
            let selectedObject = null;
            let hoveredObject = null;
            let appState = 'IDLE';
            let isEditMode = false;
            
            const objectsToDelete = [];
            const clock = new THREE.Clock();
            
            let controller0, controller1;
            let vrUiPanel; // UIパネルを格納する変数

            init();
            
            function preloadModels() {
                const loadingPromises = [
                    { name: 'イス(生成AI)', file: 'AI_chiar.glb', height: 0.79, category: 'チェア', thumbnail: 'thumbnails/chair_thumb.png' },
                    { name: 'イス(フォトグラメトリ)', file: 'photochair.glb', height: 0.79, category: 'チェア', thumbnail: 'thumbnails/chair_thumb.png' },
                    { name: '本棚', file: 'bookshelf.glb', height: 1.8, category: '収納', thumbnail: 'thumbnails/bookshelf_thumb.png' },
                    { name: '脚立', file: 'stand.glb', height: 1.2, category: 'その他', thumbnail: 'thumbnails/stand_thumb.png' },
                    { name: 'ダイニングテーブル', file: 'dining_table.glb', height: 0.75, category: 'テーブル', thumbnail: 'thumbnails/dining_table_thumb.png' },
                    { name: 'ソファ', file: 'sofa.glb', height: 0.7, category: 'ソファ', thumbnail: 'thumbnails/sofa_thumb.png' },
                    { name: 'フロアランプ', file: 'floor_lamp.glb', height: 1.5, category: '照明', thumbnail: 'thumbnails/floor_lamp_thumb.png' },
                    { name: 'デスク', file: 'desk.glb', height: 0.72, category: 'テーブル', thumbnail: 'thumbnails/desk_thumb.png' },
                    { name: 'サイドテーブル', file: 'side_table.glb', height: 0.5, category: 'テーブル', thumbnail: 'thumbnails/side_table_thumb.png' },
                    { name: 'シングルベッド', file: 'single_bed.glb', height: 0.6, category: 'ベッド', thumbnail: 'thumbnails/single_bed_thumb.png' },
                    { name: 'テレビボード', file: 'tv_board.glb', height: 0.4, category: '収納', thumbnail: 'thumbnails/tv_board_thumb.png' },
                    { name: 'ローテーブル', file: 'low_table.glb', height: 0.35, category: 'テーブル', thumbnail: 'thumbnails/low_table_thumb.png' },
                    { name: 'コートハンガー', file: 'coat_hanger.glb', height: 1.7, category: 'その他', thumbnail: 'thumbnails/coat_hanger_thumb.png' },
                ].map(item => {
                    return new Promise((resolve, reject) => {
                        loader.load(item.file, (gltf) => {
                            preloadedModels.set(item.file, gltf);
                            resolve();
                        }, undefined, reject);
                    });
                });
                Promise.all(loadingPromises)
                    .then(() => console.log("すべてのモデルの事前読み込みが完了しました！"))
                    .catch(error => console.error("モデルの事前読み込み中にエラーが発生しました。", error));
            }

            function resetScene() {
                placedObjects.forEach(object => scene.remove(object));
                placedObjects.length = 0;
                
                if (previewObject) scene.remove(previewObject);
                previewObject = null;
                selectedObject = null;
                hoveredObject = null;
                
                appState = 'IDLE';
                isEditMode = false;
            }

            function init() {
                scene = new THREE.Scene();
                camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.01, 20);
                scene.add(new THREE.HemisphereLight(0xffffff, 0xbbbbff, 3));

                renderer = new THREE.WebGLRenderer({
                    antialias: true,
                    alpha: true,
                });
                renderer.setPixelRatio(window.devicePixelRatio);
                renderer.setSize(window.innerWidth, window.innerHeight);
                renderer.xr.enabled = true;
                document.body.appendChild(renderer.domElement);
                
                renderer.xr.addEventListener('sessionstart', () => {
                    document.getElementById('title-container').style.display = 'none';
                    document.getElementById('overlay').style.pointerEvents = 'none';
                    resetScene();
                    isEditMode = true;
                    initializeVRExperience();
                    preloadModels();
                });

                renderer.xr.addEventListener('sessionend', () => {
                    document.getElementById('title-container').style.display = 'block';
                    document.getElementById('overlay').style.pointerEvents = 'auto';
                    resetScene();
                });

                animate();

                document.body.appendChild(VRButton.createButton(renderer, {
                    requiredFeatures: ['local-floor'],
                }));
            }
            
            function createVrUiPanel() {
                const panelGroup = new THREE.Group();
                
                // パネルの背景
                const panelGeometry = new THREE.PlaneGeometry(0.3, 0.4);
                const panelMaterial = new THREE.MeshBasicMaterial({
                    color: 0x2d3748,
                    transparent: true,
                    opacity: 0.8,
                    side: THREE.DoubleSide
                });
                const panelMesh = new THREE.Mesh(panelGeometry, panelMaterial);
                panelMesh.position.set(0, 0, -0.2);
                panelMesh.rotation.x = Math.PI / 4;
                panelGroup.add(panelMesh);
                
                // 「Add」ボタンの作成（プレースホルダー）
                const buttonGeometry = new THREE.BoxGeometry(0.1, 0.05, 0.02);
                const buttonMaterial = new THREE.MeshBasicMaterial({ color: 0x4299e1 });
                const addButton = new THREE.Mesh(buttonGeometry, buttonMaterial);
                addButton.position.set(0, -0.1, -0.19);
                addButton.name = 'addButton';
                panelGroup.add(addButton);
                
                return panelGroup;
            }

            function initializeVRExperience() {
                // VRコントローラーのセットアップ
                controller0 = renderer.xr.getController(0); // 利き手 (右手)
                controller1 = renderer.xr.getController(1); // 利き手と反対 (左手)
                scene.add(controller0);
                scene.add(controller1);

                // コントローラーモデルの読み込みとシーンへの追加
                const controllerModelFactory = new XRControllerModelFactory();
                const controllerGrip0 = renderer.xr.getControllerGrip(0);
                controllerGrip0.add(controllerModelFactory.createControllerModel(controllerGrip0));
                scene.add(controllerGrip0);

                const controllerGrip1 = renderer.xr.getControllerGrip(1);
                controllerGrip1.add(controllerModelFactory.createControllerModel(controllerGrip1));
                scene.add(controllerGrip1);

                // レイ（光線）の作成
                const geometry = new THREE.BufferGeometry().setFromPoints([
                    new THREE.Vector3(0, 0, 0),
                    new THREE.Vector3(0, 0, -1)
                ]);
                const line = new THREE.Line(geometry);
                line.name = 'line';
                line.scale.z = 5;
                
                const line0 = line.clone();
                controller0.add(line0);
                
                const line1 = line.clone();
                controller1.add(line1);

                // VR UIパネルの作成とコントローラーへのアタッチ
                vrUiPanel = createVrUiPanel();
                controller1.add(vrUiPanel);

                // VRコントローラーイベントリスナー
                controller0.addEventListener('selectstart', onSelectStart);
                controller0.addEventListener('selectend', onSelectEnd);
                
                controller1.addEventListener('selectstart', onSelectStart);
                controller1.addEventListener('selectend', onSelectEnd);
            }

            // AR版の不要なUI関連関数を削除
            // function setupUI() { ... }
            // function updateAllCategories() { ... }
            // function populateCategories() { ... }
            // function displayFurniture() { ... }
            // function adjustModalForKeyboard() { ... }
            // function activateCategoryTab() { ... }

            function onSelectStart(event) {
                console.log("Select start event triggered");

                // レイキャスターの交差判定をここで実行
                // 例：const intersects = raycaster.intersectObjects(vrUiPanel.children, true);
                // intersectObjects()の対象にUIパネルを追加する必要がある
            }

            function onSelectEnd(event) {
                console.log("Select end event triggered");
            }

            // AR版の不要な関数を削除
            // function updateSliderForObject() { ... }
            // function updateSliderHandlePosition() { ... }
            // function updateScaleFromSlider() { ... }
            // function onSelect() { ... }
            // function onRotate() { ... }
            // function startDeleteAnimation() { ... }
            // function onDelete() { ... }
            // function placeNewObject() { ... }
            // function updatePreviewObject() { ... }
            // function getDistance() { ... }
            // function setupRotationButtonEvents() { ... }
            // function onObjectTap() { ... }
            // function handleLongPress() { ... }
            // function handleTouchStart() { ... }
            // function handleTouchMove() { ... }
            // function handleTouchEnd() { ... }

            function setObjectTransparency(object, isTransparent, opacity = 0.7) {
                if (!object) return;
                object.traverse(child => {
                    if (child.isMesh) {
                        child.material.transparent = true;
                        child.material.opacity = isTransparent ? opacity : 1.0;
                    }
                });
            }

            function updateUI() {
                // VR版ではDOM UIがないため、この関数は事実上不要
            }

            function animate() {
                renderer.setAnimationLoop(render);
            }

            function render() {
                if (!renderer.xr.isPresenting) {
                    return;
                }
                
                // VRコントローラーのレイキャスターを更新
                const tempMatrix = new THREE.Matrix4();
                tempMatrix.identity().extractRotation(controller0.matrixWorld);
                raycaster.ray.origin.setFromMatrixPosition(controller0.matrixWorld);
                raycaster.ray.direction.set(0, 0, -1).applyMatrix4(tempMatrix);

                // UIパネルのホバー状態を処理
                // handleUiHover();

                renderer.render(scene, camera);
            }
        }
        main();
    </script>
</body>
</html>
