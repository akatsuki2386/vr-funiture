<!DOCTYPE html>
<html>
  <head>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script>
      // 白い手モデルを非表示にするコンポーネント
      AFRAME.registerComponent('hide-controller-model', {
        init: function() {
          const controllerEl = this.el;
          
          controllerEl.addEventListener('model-loaded', () => {
            const mesh = controllerEl.getObject3D('mesh');
            if (mesh) {
              mesh.visible = false;
            }
          });
        }
      });

      // 左手コントローラーUIのコンポーネント
      AFRAME.registerComponent('left-hand-ui', {
        init: function() {
          const controllerEl = this.el;
          
          // エンティティがロードされた後にUIパネルを作成
          controllerEl.addEventListener('loaded', () => {
            const uiPanel = document.createElement('a-entity');
            uiPanel.setAttribute('id', 'ui-panel-left');
            uiPanel.setAttribute('geometry', {
              primitive: 'plane',
              width: 0.5,
              height: 0.3
            });
            uiPanel.setAttribute('material', {
              color: '#fff',
              transparent: true,
              opacity: 0.8
            });
            
            // パネルのヘッダーテキスト
            const headerText = document.createElement('a-entity');
            headerText.setAttribute('text', {
              value: 'Controls',
              color: '#000',
              align: 'center',
              width: 1.2
            });
            headerText.setAttribute('position', '0 0.1 0.01');
            uiPanel.appendChild(headerText);

            // + ボタンとテキストを子要素として作成
            const plusButton = document.createElement('a-entity');
            plusButton.setAttribute('id', 'plus-button');
            plusButton.setAttribute('geometry', {
              primitive: 'plane',
              width: 0.2,
              height: 0.2
            });
            plusButton.setAttribute('material', {
              color: '#4CAF50',
              transparent: true,
              opacity: 0.5
            });
            plusButton.setAttribute('text', {
              value: '+',
              color: '#fff',
              align: 'center',
              width: 0.5
            });
            plusButton.setAttribute('position', '-0.15 -0.05 0.01'); // 左端に配置
            uiPanel.appendChild(plusButton);
            
            // モデルの追加テキストを作成
            const addModelText = document.createElement('a-entity');
            addModelText.setAttribute('text', {
              value: 'モデルの追加',
              color: '#000',
              align: 'left',
              width: 0.7
            });
            addModelText.setAttribute('position', '-0.05 -0.05 0.01'); // ＋ボタンの右に配置
            uiPanel.appendChild(addModelText);

            // コントローラーの正面にパネルを配置
            uiPanel.setAttribute('position', '0 0.1 -0.5'); 
            controllerEl.appendChild(uiPanel);
          });
        }
      });

      // 右手コントローラーのインタラクション処理
      AFRAME.registerComponent('right-hand-interactions', {
        init: function() {
          const controllerEl = this.el;
          
          // トリガーが押されたときの処理
          controllerEl.addEventListener('triggerdown', () => {
            const raycaster = controllerEl.components.raycaster;
            if (raycaster && raycaster.intersections.length > 0) {
              const intersectedEl = raycaster.intersections[0].object.el;

              // 交差した要素が + ボタンかチェック
              if (intersectedEl.id === 'plus-button') {
                console.log('+ button activated!');
                // 新しいボックスを生成
                const newBox = document.createElement('a-box');
                newBox.setAttribute('position', '0 1 -2');
                newBox.setAttribute('rotation', '0 45 0');
                newBox.setAttribute('color', '#FFC300');
                newBox.setAttribute('shadow', '');
                newBox.setAttribute('class', 'collidable');
                document.querySelector('a-scene').appendChild(newBox);
              } else {
                // レイキャストが当たった最初のオブジェクトをハイライト
                intersectedEl.setAttribute('material', 'color', '#FF0000');
              }
            }
          });
          
          // トリガーが離されたときの処理
          controllerEl.addEventListener('triggerup', () => {
            const raycaster = controllerEl.components.raycaster;
            if (raycaster && raycaster.intersections.length > 0) {
              const intersectedEl = raycaster.intersections[0].object.el;
              // ハイライトを元に戻す
              if (intersectedEl.id !== 'plus-button') {
                intersectedEl.setAttribute('material', 'color', '#4CC3D9');
              }
            }
          });
        }
      });
    </script>
    <style>
      #startButton {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        padding: 20px 40px;
        font-size: 24px;
        cursor: pointer;
        z-index: 999;
        background-color: #4CAF50;
        color: white;
        border: none;
        border-radius: 10px;
      }
    </style>
  </head>
  <body>
    <button id="startButton">START</button>

    <a-scene 
      id="ar-scene"
      xr-mode-ui="true" 
      renderer="colorManagement: true;" 
      ar-mode-ui="enabled: false;"
      embedded>
      
      <a-camera 
        look-controls 
        ar-camera-mode="true" 
        position="0 1.6 0">
      </a-camera>

      <a-entity 
        id="left-hand" 
        tracked-controls="hand: left"
        left-hand-ui
        hide-controller-model>
      </a-entity>
      
      <a-entity 
        id="right-hand" 
        tracked-controls="hand: right"
        raycaster="objects: .collidable, #plus-button;" 
        right-hand-interactions
        hide-controller-model>
      </a-entity>

      <a-box 
        class="collidable" 
        position="-1 0.5 -3" 
        rotation="0 45 0" 
        color="#4CC3D9" 
        shadow>
      </a-box>
      <a-sphere 
        class="collidable" 
        position="1 0.5 -3" 
        rotation="0 45 0" 
        color="#EF2D5E" 
        shadow>
      </a-sphere>

    </a-scene>
    
    <script>
      document.getElementById('startButton').addEventListener('click', () => {
        const sceneEl = document.querySelector('a-scene');
        if (sceneEl.hasLoaded) {
          sceneEl.enterAR();
          document.getElementById('startButton').style.display = 'none';
        }
      });
    </script>
  </body>
</html>
