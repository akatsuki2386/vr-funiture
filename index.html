<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>VR Furniture Planner</title>
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-extras@6.1.1/dist/aframe-extras.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/aframe-event-set-component@4.2.1/dist/aframe-event-set-component.min.js"></script>
    
    <script>
      document.addEventListener('DOMContentLoaded', () => {
        const startVrBtn = document.getElementById('start-vr-btn');
        const vrScene = document.querySelector('a-scene');

        startVrBtn.addEventListener('click', () => {
          // VRモードへの移行を試みる
          if (vrScene.hasLoaded) {
            vrScene.enterVR();
          } else {
            vrScene.addEventListener('loaded', () => {
              vrScene.enterVR();
            });
          }
        });

        vrScene.addEventListener('enter-vr', () => {
            // VRモードに移行した際にUIを非表示にする
            document.getElementById('start-ui').style.display = 'none';
            
            // 利き手（ここでは仮に右利きと設定）に応じてUIを生成
            const handedness = 'right'; // テストのため、一旦固定
            
            const rightHand = document.getElementById('right-hand');
            const leftHand = document.getElementById('left-hand');
            
            // レイキャストの追加
            rightHand.setAttribute('raycaster', 'objects: .collidable; showLine: true; far: 5;');
            leftHand.setAttribute('raycaster', 'objects: .collidable; showLine: true; far: 5;');
            
            const uiPanel = createUIPanel();
            
            if (handedness === 'right') {
                leftHand.appendChild(uiPanel);
            } else {
                rightHand.appendChild(uiPanel);
            }
        });
        
        // UIパネルを生成する関数
        function createUIPanel() {
            const panelContainer = document.createElement('a-entity');
            panelContainer.setAttribute('position', '0 0.2 -0.5');
            panelContainer.setAttribute('rotation', '-15 0 0');

            const mainMenu = document.createElement('a-plane');
            mainMenu.setAttribute('width', '0.5');
            mainMenu.setAttribute('height', '0.8');
            mainMenu.setAttribute('color', '#333');
            mainMenu.setAttribute('opacity', '0.7');
            
            const addButton = document.createElement('a-plane');
            addButton.setAttribute('width', '0.4');
            addButton.setAttribute('height', '0.1');
            addButton.setAttribute('color', '#5cb85c');
            addButton.setAttribute('position', '0 0.3 0.01');
            addButton.setAttribute('text', 'value: モデルの追加; align: center; color: white;');
            addButton.classList.add('collidable');
            
            const helpButton = document.createElement('a-plane');
            helpButton.setAttribute('width', '0.4');
            helpButton.setAttribute('height', '0.1');
            helpButton.setAttribute('color', '#f0ad4e');
            helpButton.setAttribute('position', '0 0 0.01');
            helpButton.setAttribute('text', 'value: 動作の説明; align: center; color: white;');
            helpButton.classList.add('collidable');

            const exitButton = document.createElement('a-plane');
            exitButton.setAttribute('width', '0.4');
            exitButton.setAttribute('height', '0.1');
            exitButton.setAttribute('color', '#d9534f');
            exitButton.setAttribute('position', '0 -0.3 0.01');
            exitButton.setAttribute('text', 'value: シミュレーションの終了; align: center; color: white;');
            exitButton.classList.add('collidable');
            
            mainMenu.appendChild(addButton);
            mainMenu.appendChild(helpButton);
            mainMenu.appendChild(exitButton);
            panelContainer.appendChild(mainMenu);
            
            return panelContainer;
        }
      });
    </script>
  </head>
  <body>
    <div id="start-ui" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 1000; background: rgba(0, 0, 0, 0.7); padding: 5vw; border-radius: 10px; text-align: center; color: white; font-family: sans-serif; box-sizing: border-box; max-width: 90vw;">
      <h1>VR Furniture Planner</h1>
      <button id="start-vr-btn" style="padding: 1vw 2vw; margin: 1vw; font-size: 3vw;">START VR</button>
    </div>

    <a-scene 
      webxr="requiredFeatures: passthrough, immersive-vr" 
      renderer="colorManagement: true;"
    >
      <a-assets>
        </a-assets>

      <a-entity id="left-hand" hand-controls="hand: left;"></a-entity>
      <a-entity id="right-hand" hand-controls="hand: right;"></a-entity>

      <a-entity id="ui-panel-holder"></a-entity>
      
      <a-entity camera look-controls wasd-controls></a-entity>
      
      <a-sky color="#ECECEC"></a-sky>
    </a-scene>
  </body>
</html>
